<!DOCTYPE html>
<html lang="z">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>Spring Cloud Eureka服务续约(Renew)源码分析 | 诺诺清蔓</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="一个对技术追求的Java萌妹子">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Spring Cloud Eureka服务续约(Renew)源码分析 | 诺诺清蔓">
    <meta name="twitter:description" content="一个对技术追求的Java萌妹子">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Spring Cloud Eureka服务续约(Renew)源码分析 | 诺诺清蔓">
    <meta property="og:description" content="一个对技术追求的Java萌妹子">

    
    <meta name="author" content="吕清燕">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/avatar-small.png">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="诺诺清蔓" href="/atom.xml">
    

    <link rel="canonical" href="http://lvqingyan.com/sc-eureka-renew/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(http://simg.sinajs.cn/blog7newtpl/image/30/30_2/images/bg.gif)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 诺诺清蔓 的主页"><img src="/images/avatar.jpg" width="120" alt="诺诺清蔓 logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for 诺诺清蔓">诺诺清蔓</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">简单，美好，奋发</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">一个对技术追求的Java萌妹子</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
            <li class="navigation__item"><a href="/">首页</a></li>
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">文字阁</a></li>
            
              <li class="navigation__item"><a href="/favourite">黄金屋</a></li>
            
              <li class="navigation__item"><a href="/favourite/time.html">时光机</a></li>
            
              <li class="navigation__item"><a href="/favourite/image.html">幻想间</a></li>
            
              <li class="navigation__item"><a href="/aboutme">关于我</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/llqm" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  <li class="navigation__item">
    <a href="https://twitter.com/llqm" title="上Twitter找我" target="_blank">
      <i class='social fa fa-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li>

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-disabled"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2016-11-13T06:00:00.000Z" class="post-list__meta--date date">2016-11-13</time> &#8226; <span class="post-meta__tags tags">于 
  <a class="tag-link" href="/tags/Spring-Cloud-Eureka/">Spring Cloud Eureka</a>, <a class="tag-link" href="/tags/Spring-Cloud-源码分析/">Spring Cloud 源码分析</a>
 </span>
      <span class="page-pv">
       阅读 <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">Spring Cloud Eureka服务续约(Renew)源码分析</h1>
  </header>

  <section class="post">
    <p><strong>摘要</strong>:在本篇文章中主要对Eureka的Renew(服务续约)，从服务提供者发起续约请求开始分析，通过阅读源码和画时序图的方式，展示Eureka服务续约的整个生命周期。服务续约主要是把服务续约的信息更新到自身的Eureka Server中，然后再同步到其它Eureka Server中。</p>
<h2 id="Renew-服务续约"><a href="#Renew-服务续约" class="headerlink" title="Renew(服务续约)"></a>Renew(服务续约)</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Renew（服务续约）操作由Service Provider定期调用，类似于heartbeat。目的是隔一段时间Service Provider调用接口，告诉Eureka Server它还活着没挂，不要把它T了。通俗的说就是它们两之间的心跳检测，避免服务提供者被剔除掉。<br>请参考:<a href="http://blog.xujin.org/sc/sc-eureka-mid/#名词解释" target="_blank" rel="external">Spring Cloud Eureka名词解释</a><br><a id="more"></a></p>
<h3 id="服务续约配置"><a href="#服务续约配置" class="headerlink" title="服务续约配置"></a>服务续约配置</h3><p>  Renew操作会在Service Provider定时发起，用来通知Eureka Server自己还活着。 这里有两个比较重要的配置需要如下，可以在Run之前配置。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eureka.instance.leaseRenewalIntervalInSeconds</div></pre></td></tr></table></figure></p>
<p>  Renew频率。默认是<code>30秒</code>，也就是每30秒会向Eureka Server发起Renew操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eureka.instance.leaseExpirationDurationInSeconds</div></pre></td></tr></table></figure></p>
<p> 服务失效时间。默认是<code>90秒</code>，也就是如果Eureka Server在90秒内没有接收到来自Service Provider的Renew操作，就会把<code>Service Provider剔除</code>。</p>
<h2 id="Renew源码分析"><a href="#Renew源码分析" class="headerlink" title="Renew源码分析"></a>Renew源码分析</h2><h3 id="服务提供者实现细节"><a href="#服务提供者实现细节" class="headerlink" title="服务提供者实现细节"></a>服务提供者实现细节</h3><p> 服务提供者发发起服务续约的时序图，如下图所示,大家先直观的看一下时序图，等阅读完源码再回顾一下。<br><img src="/images/spring-cloud-netflix/eureka/service-renew.png" alt="服务提供者发起续约时序图"></p>
<ol>
<li>在com.netflix.discovery.DiscoveryClient.initScheduledTasks()中的1272行，TimedSupervisorTask会定时发起服务续约，代码如下所示:<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Heartbeat timer</span></div><div class="line">  scheduler.schedule(</div><div class="line">     <span class="keyword">new</span> TimedSupervisorTask(</div><div class="line">            <span class="string">"heartbeat"</span>,</div><div class="line">             scheduler,</div><div class="line">             heartbeatExecutor,</div><div class="line">             renewalIntervalInSecs,</div><div class="line">             TimeUnit.SECONDS,</div><div class="line">             expBackOffBound,</div><div class="line">              <span class="keyword">new</span> HeartbeatThread()</div><div class="line">            ),</div><div class="line">  renewalIntervalInSecs, TimeUnit.SECONDS);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>2.在com.netflix.discovery.DiscoveryClient中的1393行，有一个<code>HeartbeatThread</code>线程发起续约操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">//调用eureka-client中的renew</span></div><div class="line">            <span class="keyword">if</span> (renew()) &#123;</div><div class="line">                lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>renew()调用eureka-client-1.4.11.jarcom.netflix.discovery.DiscoveryClient中<code>829</code>行renew()发起<code>PUT Reset</code>请求，调用com.netflix.eureka.resources.InstanceResource中的renewLease()续约。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Renew with the eureka service by making the appropriate REST call</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">       EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="keyword">null</span>);</div><div class="line">           logger.debug(<span class="string">"&#123;&#125; - Heartbeat status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</div><div class="line">           <span class="keyword">if</span> (httpResponse.getStatusCode() == <span class="number">404</span>) &#123;</div><div class="line">               REREGISTER_COUNTER.increment();</div><div class="line">               logger.info(<span class="string">"&#123;&#125; - Re-registering apps/&#123;&#125;"</span>, PREFIX + appPathIdentifier, instanceInfo.getAppName());</div><div class="line">               <span class="keyword">return</span> register();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">200</span>;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">           logger.error(<span class="string">"&#123;&#125; - was unable to send heartbeat!"</span>, PREFIX + appPathIdentifier, e);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h3 id="Netflix中的Eureka-Core实现细节"><a href="#Netflix中的Eureka-Core实现细节" class="headerlink" title="Netflix中的Eureka Core实现细节"></a>Netflix中的Eureka Core实现细节</h3><p>   NetFlix中Eureka Core中的服务续约时序图，如下图所示。<br>  <img src="/images/spring-cloud-netflix/eureka/eureka-renew.png" alt="服务续约时序图"></p>
<ol>
<li><p>打开<code>com.netflix.eureka.resources.InstanceResource</code>中的<code>106</code>行的<code>renewLease()</code>方法，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> PeerAwareInstanceRegistry registry</div><div class="line"><span class="meta">@PUT</span></div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">renewLease</span><span class="params">(</span></span></div><div class="line">        @HeaderParam(PeerEurekaNode.HEADER_REPLICATION) String isReplication,</div><div class="line">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"overriddenstatus"</span>)</span> String overriddenStatus,</div><div class="line">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"status"</span>)</span> String status,</div><div class="line">        @<span class="title">QueryParam</span><span class="params">(<span class="string">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) &#123;</div><div class="line">    <span class="keyword">boolean</span> isFromReplicaNode = <span class="string">"true"</span>.equals(isReplication);</div><div class="line">    <span class="comment">//调用</span></div><div class="line">    <span class="keyword">boolean</span> isSuccess = registry.renew(app.getName(), id, isFromReplicaNode);</div><div class="line">    <span class="comment">//其余省略</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>点开registry.renew(app.getName(), id, isFromReplicaNode);我们可以看到，调用了<code>org.springframework.cloud.netflix.eureka.server.InstanceRegistry</code>中的<code>renew（）</code>方法，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String serverId,</span></span></div><div class="line">			<span class="keyword">boolean</span> isReplication) &#123;</div><div class="line">		log(<span class="string">"renew "</span> + appName + <span class="string">" serverId "</span> + serverId + <span class="string">", isReplication &#123;&#125;"</span></div><div class="line">				+ isReplication);</div><div class="line">		List&lt;Application&gt; applications = getSortedApplications();</div><div class="line">		<span class="keyword">for</span> (Application input : applications) &#123;</div><div class="line">			<span class="keyword">if</span> (input.getName().equals(appName)) &#123;</div><div class="line">				InstanceInfo instance = <span class="keyword">null</span>;</div><div class="line">				<span class="keyword">for</span> (InstanceInfo info : input.getInstances()) &#123;</div><div class="line">					<span class="keyword">if</span> (info.getHostName().equals(serverId)) &#123;</div><div class="line">						instance = info;</div><div class="line">						<span class="keyword">break</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				publishEvent(<span class="keyword">new</span> EurekaInstanceRenewedEvent(<span class="keyword">this</span>, appName, serverId,</div><div class="line">						instance, isReplication));</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">        <span class="comment">//调用com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl中的renew方法</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.renew(appName, serverId, isReplication);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>3.从<code>super.renew()</code>看到调用了父类中的<code>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl</code>中<code>420</code>行的<code>renew()</code>方法，代码如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id, <span class="keyword">final</span> <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">        <span class="comment">//服务续约成功，</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">super</span>.renew(appName, id, isReplication)) &#123;</div><div class="line">            <span class="comment">//然后replicateToPeers同步其它Eureka Server中的数据</span></div><div class="line">            replicateToPeers(Action.Heartbeat, appName, id, <span class="keyword">null</span>, <span class="keyword">null</span>, isReplication);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3.1 从上面代码中<code>super.renew(appName, id, isReplication)</code>可以看出调用的是com.netflix.eureka.registry.AbstractInstanceRegistry中<code>345</code>行的renew()方法，代码如下所示<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">renew</span><span class="params">(String appName, String id, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</div><div class="line">      RENEW.increment(isReplication);</div><div class="line">      Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);</div><div class="line">      Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">if</span> (gMap != <span class="keyword">null</span>) &#123;</div><div class="line">          leaseToRenew = gMap.get(id);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (leaseToRenew == <span class="keyword">null</span>) &#123;</div><div class="line">          RENEW_NOT_FOUND.increment(isReplication);</div><div class="line">          logger.warn(<span class="string">"DS: Registry: lease doesn't exist, registering resource: &#123;&#125; - &#123;&#125;"</span>, appName, id);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          InstanceInfo instanceInfo = leaseToRenew.getHolder();</div><div class="line">          <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="comment">// touchASGCache(instanceInfo.getASGName());</span></div><div class="line">              InstanceStatus overriddenInstanceStatus = <span class="keyword">this</span>.getOverriddenInstanceStatus(</div><div class="line">                      instanceInfo, leaseToRenew, isReplication);</div><div class="line">              <span class="keyword">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;</div><div class="line">                  logger.info(<span class="string">"Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;"</span></div><div class="line">                          + <span class="string">"; re-register required"</span>, instanceInfo.getId());</div><div class="line">                  RENEW_NOT_FOUND.increment(isReplication);</div><div class="line">                  <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;</div><div class="line">                  Object[] args = &#123;</div><div class="line">                          instanceInfo.getStatus().name(),</div><div class="line">                          instanceInfo.getOverriddenStatus().name(),</div><div class="line">                          instanceInfo.getId()</div><div class="line">                  &#125;;</div><div class="line">                  logger.info(</div><div class="line">                          <span class="string">"The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. "</span></div><div class="line">                                  + <span class="string">"Hence setting the status to overridden status"</span>, args);</div><div class="line">                  instanceInfo.setStatus(overriddenInstanceStatus);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          renewsLastMin.increment();</div><div class="line">          leaseToRenew.renew();</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>其中 <code>leaseToRenew.renew()</code>是调用com.netflix.eureka.lease.Lease<t>中的<code>62</code>行的renew()方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Renew the lease, use renewal duration if it was specified by the</div><div class="line"> * associated &#123;<span class="doctag">@link</span> T&#125; during registration, otherwise default duration is</div><div class="line"> * &#123;<span class="doctag">@link</span> #DEFAULT_DURATION_IN_SECS&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</div><div class="line">    lastUpdateTimestamp = System.currentTimeMillis() + duration;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></t></p>
<p>3.2 replicateToPeers(Action.Heartbeat, appName, id, null, null, isReplication);调用自身的<code>replicateToPeers()</code>方法，在com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl中的<code>618</code>行，主要接口实现方式和register基本一致：首先更新自身Eureka Server中服务的状态，再同步到其它Eureka Server中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replicateToPeers</span><span class="params">(Action action, String appName, String id,</span></span></div><div class="line">                                  InstanceInfo info <span class="comment">/* optional */</span>,</div><div class="line">                                  InstanceStatus newStatus <span class="comment">/* optional */</span>, <span class="keyword">boolean</span> isReplication) &#123;</div><div class="line">        Stopwatch tracer = action.getTimer().start();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (isReplication) &#123;</div><div class="line">                numberOfReplicationsLastMin.increment();</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// If it is a replication already, do not replicate again as this will create a poison replication</span></div><div class="line">            <span class="keyword">if</span> (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 同步把续约信息同步到其它的Eureka Server中</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) &#123;</div><div class="line">                <span class="comment">// If the url represents this host, do not replicate to yourself.</span></div><div class="line">                <span class="keyword">if</span> (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//根据action做相应操作的同步</span></div><div class="line">                replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            tracer.stop();</div><div class="line">        &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>至此，Eureka服务续约源码分析结束，大家有兴趣可自行阅读。</p>
<h3 id="源码分析链接"><a href="#源码分析链接" class="headerlink" title="源码分析链接"></a>源码分析链接</h3><p> 其它源码分析链接:<br> Spring Cloud中@EnableEurekaClient源码分析:<br> <a href="http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/" target="_blank" rel="external">http://blog.xujin.org/sc/sc-enableEurekaClient-annonation/</a><br> Spring Cloud Eureka服务注册源码分析：<br> <a href="http://blog.xujin.org/sc/sc-eureka-register/" target="_blank" rel="external">http://blog.xujin.org/sc/sc-eureka-register/</a></p>

  </section>

</article>

<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/sc-eureka-cancle/" title="Spring Cloud Eureka服务下线(Cancel)源码分析">Spring Cloud Eureka服务下线(Cancel)源码分析</a></h2>
                <p class="excerpt">
                
                摘要:在本篇文章中主要对Eureka的Cancel(服务下线)进行源码分析，在Service Provider服务shut down的时候，需要及时通知Eureka Server把自己剔除，从而避免其它客户端调用已经下线的服务，导致服务不可用。
Cancel(服务下线)概述在Service Provider服务shut down的时候，需要及时通知Eureka Server把自己剔除，从而避免客户端调用已经下线的服务。
服务提供者端源码分析
在eureka-client-1.4.1中的com.netflix.discovery.DiscoveryClient中shutdown()的867行。
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2016-11-19T06:00:00.000Z" class="post-list__meta--date date">2016-11-19</time> &#8226; <span class="post-list__meta--tags tags">于 
  <a class="tag-link" href="/tags/Spring-Cloud-Eureka/">Spring Cloud Eureka</a>, <a class="tag-link" href="/tags/Spring-Cloud-源码分析/">Spring Cloud 源码分析</a>
</span><a class="btn-border-small" href="/sc-eureka-cancle/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/sc-enableEurekaClient-annonation/" title="Spring Cloud中@EnableEurekaClient源码分析">Spring Cloud中@EnableEurekaClient源码分析</a></h2>
                <p class="excerpt">
                
                摘要:在这篇文章中主要介绍一下Spring Cloud中的@EnableEurekaClient注解，从源码的角度分析是如何work的，让大家能了解Spring Cloud如何通过@EnableEurekaClient注解对NetFlix Eureka Client进行封装为它所用。
NetFlix Eureka client简介NetFlix Eureka clientEureka client 负责与Eureka Server 配合向外提供注册与发现服务接口。首先看下eureka client是怎么定义，Netflix的 eureka client的行为在LookupService中定义，Lookup service for finding active instances，定义了，从outline中能看到起“规定”了如下几个最基本的方法。服务发现必须实现的基本类：com.netflix.discovery.shared.LookupService，可以自行查看源码。
Eureka client与Spring Cloud类关系 Eureka client与Spring Cloud Eureka Client类图，如下所示:在上图中，我加了前缀，带有S的是Spring Cloud封装的，带有N是NetFlix原生的。
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2016-11-06T06:00:00.000Z" class="post-list__meta--date date">2016-11-06</time> &#8226; <span class="post-list__meta--tags tags">于 
  <a class="tag-link" href="/tags/Spring-Cloud-Eureka/">Spring Cloud Eureka</a>, <a class="tag-link" href="/tags/Spring-Cloud-源码分析/">Spring Cloud 源码分析</a>
</span><a class="btn-border-small" href="/sc-enableEurekaClient-annonation/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

  

            <footer class="footer">
    <span class="footer__copyright">
        &copy; 2018 吕清燕 - 本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
       
    </span>
    <span class="footer__copyright">
             - 基于 <a href="http://hexo.io">Hexo</a> 搭建。
         </span>
       
    
    
</footer>


        </div>
    </div>

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-78918255-1', 'auto');
	ga('send', 'pageview');
</script>

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?9cdad07c755fa23f6aced510c6760e87";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
